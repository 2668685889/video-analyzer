name: Build Windows Executable

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        python-version: ['3.12']
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: å‡çº§pip
      run: |
        python -m pip install --upgrade pip
    
    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: æ¸…ç†ç¼“å­˜æ–‡ä»¶
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        if (Test-Path dist) { Remove-Item -Recurse -Force dist }
        Get-ChildItem -Path . -Recurse -Name "__pycache__" | Remove-Item -Recurse -Force
    
    - name: ç¼–è¯‘Windowså¯æ‰§è¡Œæ–‡ä»¶
      run: |
        pyinstaller main.spec --clean --noconfirm --log-level INFO
    
    - name: éªŒè¯ç¼–è¯‘ç»“æžœ
      run: |
        if (Test-Path "dist\VideoAnalyzer\VideoAnalyzer.exe") {
          Write-Host "âœ… ç¼–è¯‘æˆåŠŸï¼"
          $fileSize = (Get-Item "dist\VideoAnalyzer\VideoAnalyzer.exe").Length
          Write-Host "ðŸ“¦ æ–‡ä»¶å¤§å°: $([math]::Round($fileSize/1MB, 2)) MB"
        } else {
          Write-Host "âŒ ç¼–è¯‘å¤±è´¥ï¼šæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          exit 1
        }
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        Compress-Archive -Path "dist\VideoAnalyzer\*" -DestinationPath "VideoAnalyzer-Windows-${{ github.sha }}.zip"
    
    - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: VideoAnalyzer-Windows-${{ matrix.python-version }}
        path: |
          dist/VideoAnalyzer/
          VideoAnalyzer-Windows-${{ github.sha }}.zip
        retention-days: 30
    
    - name: å‘å¸ƒåˆ°Releaseï¼ˆä»…æ ‡ç­¾è§¦å‘ï¼‰
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: VideoAnalyzer-Windows-${{ github.sha }}.zip
        name: VideoAnalyzer ${{ github.ref_name }}
        body: |
          ## ðŸŽ‰ VideoAnalyzer Windowsç‰ˆæœ¬ ${{ github.ref_name }}
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          1. ä¸‹è½½ `VideoAnalyzer-Windows-*.zip` æ–‡ä»¶
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `VideoAnalyzer.exe` è¿è¡Œç¨‹åº
          
          ### ðŸ”§ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 (æŽ¨è)
          - Windows 8.1 (æœ€ä½Žæ”¯æŒ)
          - 64ä½ç³»ç»Ÿ
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å‡ ç§’é’ŸåŠ è½½æ—¶é—´
          - å¦‚é‡æ€æ¯’è½¯ä»¶æŠ¥è­¦ï¼Œè¯·æ·»åŠ ä¿¡ä»»
          - è¯·ä¿æŒæ‰€æœ‰æ–‡ä»¶å®Œæ•´ï¼Œä¸è¦å•ç‹¬å¤åˆ¶exeæ–‡ä»¶
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æž„å»ºä¿¡æ¯æ±‡æ€»
  build-summary:
    needs: build-windows
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æž„å»ºç»“æžœæ±‡æ€»
      run: |
        echo "## ðŸ—ï¸ æž„å»ºç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ | Pythonç‰ˆæœ¬ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | ${{ needs.build-windows.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} | 3.12 |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.build-windows.result }}" = "success" ]; then
          echo "ðŸŽ‰ Windowsç‰ˆæœ¬ç¼–è¯‘æˆåŠŸï¼å¯åœ¨Actionsé¡µé¢ä¸‹è½½ç¼–è¯‘äº§ç‰©ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Windowsç‰ˆæœ¬ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
        fi