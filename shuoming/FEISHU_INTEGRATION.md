# 飞书多维表格集成功能说明

## 功能概述

本项目集成了飞书多维表格功能，可以将视频分析结果自动同步到飞书多维表格中，方便团队协作和数据管理。

## 主要功能

### 1. 数据同步
- 自动将视频分析结果同步到飞书多维表格
- 支持手动同步和自动同步两种模式
- 同步状态跟踪（未同步、同步中、已同步、同步失败）

### 2. 配置管理
- 在设置界面中配置飞书应用信息
- 支持测试连接功能
- 支持自动设置表格结构

### 3. 数据管理
- 记录飞书记录ID，支持数据更新
- 支持批量同步操作
- 提供同步统计信息

## 配置步骤

### 1. 创建飞书应用

1. 登录飞书开放平台：https://open.feishu.cn/
2. 创建企业自建应用
3. 获取应用凭证：
   - App ID（应用ID）
   - App Secret（应用密钥）
4. 配置应用权限：
   - `bitable:app` - 多维表格应用权限
   - `bitable:app:readonly` - 多维表格只读权限

### 2. 创建多维表格

1. 在飞书中创建新的多维表格
2. 获取多维表格信息：
   - App Token（多维表格应用令牌）
   - Table ID（数据表ID）

### 3. 应用配置

在软件设置界面的"飞书配置"区域填入以下信息：

- **应用ID**：飞书应用的App ID
- **应用密钥**：飞书应用的App Secret
- **应用令牌**：多维表格的App Token
- **表格ID**：数据表的Table ID
- **启用飞书同步**：勾选以启用同步功能
- **自动同步**：勾选以启用自动同步

### 4. 测试和设置

1. 点击"测试连接"按钮验证配置是否正确
2. 点击"设置表格结构"按钮自动创建所需的字段

## 表格字段说明

系统会在飞书多维表格中创建以下字段：

| 字段名称 | 字段类型 | 说明 |
|---------|---------|------|
| 序列号 | 文本 | 分析记录的唯一序列号 |
| 视频文件名 | 文本 | 上传的视频文件名称 |
| 分析结果 | 多行文本 | Gemini AI的分析结果 |
| 创建时间 | 日期时间 | 记录创建时间 |
| 文件大小 | 文本 | 视频文件大小 |
| 使用模型 | 文本 | 使用的AI模型 |
| 标签 | 多选 | 自动生成的内容标签 |
| Coze调用ID | 文本 | Coze API调用标识 |

## 同步机制

### 自动同步
- 当启用自动同步时，每次完成视频分析后会自动同步到飞书
- 同步失败时会记录错误信息，可在后续手动重试

### 手动同步
- 可以通过界面手动触发同步操作
- 支持批量同步未同步的记录
- 支持重新同步失败的记录

### 同步状态
- **pending**：待同步
- **syncing**：同步中
- **synced**：已同步
- **failed**：同步失败

## 文件结构

```
src/
├── api/
│   └── feishu_client.py          # 飞书API客户端
├── utils/
│   ├── config.py                 # 配置管理（包含飞书配置）
│   ├── database.py               # 数据库操作（包含同步字段）
│   └── feishu_sync.py           # 飞书同步服务
└── ui/
    └── settings_dialog.py        # 设置界面（包含飞书配置）
```

## 注意事项

1. **权限配置**：确保飞书应用具有足够的权限访问多维表格
2. **网络连接**：同步功能需要稳定的网络连接
3. **数据安全**：应用密钥等敏感信息会保存在本地.env文件中
4. **表格结构**：请勿手动修改系统创建的字段，可能影响同步功能
5. **数据一致性**：建议不要在飞书中直接修改同步的数据，以免造成数据不一致

## 故障排除

### 连接测试失败
1. 检查网络连接
2. 验证应用ID和密钥是否正确
3. 确认应用权限配置
4. 检查多维表格的App Token和Table ID

### 同步失败
1. 查看错误日志信息
2. 检查表格字段是否完整
3. 验证数据格式是否正确
4. 确认飞书服务状态

### 数据不一致
1. 使用"重新同步"功能
2. 检查本地数据库记录
3. 对比飞书表格中的数据

## 技术支持

如遇到问题，请检查：
1. 应用配置是否正确
2. 网络连接是否正常
3. 飞书服务是否可用
4. 查看应用日志获取详细错误信息

更多技术细节请参考源代码中的注释和文档。