# 智能字段模板生成功能说明

## 功能概述

智能字段模板生成功能是一个自动化分析工具，能够根据大模型分析历史记录的内容，智能生成飞书多维表格的字段模板文件。用户可以根据生成的模板手动创建飞书表格字段，确保字段结构完全符合实际需求。

## 核心特性

### 1. 智能内容分析
- **历史记录分析**：自动获取最近的视频分析记录
- **内容结构识别**：智能识别JSON格式和文本格式的分析结果
- **字段类型推断**：根据内容特征自动推断合适的飞书字段类型

### 2. 本地模板生成
- **字段映射**：将分析结果中的字段映射到飞书字段类型
- **模板保存**：生成的模板自动保存到本地文件
- **配置导出**：支持导出完整的字段配置信息和创建指南

### 3. 手动创建指导
- **详细说明**：提供详细的字段创建步骤和说明
- **配置建议**：智能推荐字段类型和配置参数
- **自定义支持**：支持用户根据实际需求调整字段配置

## 使用方法

### 前置条件
1. 系统中存在历史分析记录
2. 确保有足够的磁盘空间保存模板文件
3. 具备飞书多维表格的编辑权限（用于后续手动创建）

### 操作步骤
1. 点击主界面的"生成字段模板"按钮
2. 确认模板生成操作
3. 系统自动分析历史数据
4. 生成本地字段模板文件
5. 根据生成的模板和指南手动创建飞书字段
6. 完成后即可正常同步数据到飞书

## 技术实现

### 核心模块

#### 1. FieldMapper 类
- **位置**：`src/utils/field_mapper.py`
- **功能**：分析内容结构，推断字段类型
- **核心方法**：
  - `analyze_content_structure()`: 分析内容结构
  - `infer_field_type()`: 推断字段类型
  - `generate_feishu_field_template()`: 生成飞书字段模板

#### 2. SmartFieldSetup 类
- **位置**：`src/utils/smart_field_setup.py`
- **功能**：执行智能模板生成流程
- **核心方法**：
  - `analyze_historical_data()`: 分析历史数据
  - `generate_smart_field_template()`: 生成智能模板
  - `run_smart_setup()`: 运行模板生成流程
  - `_get_field_type_summary()`: 统计字段类型分布

### 字段类型映射

| 内容特征 | 飞书字段类型 | 类型代码 |
|---------|-------------|----------|
| 短文本 | 单行文本 | 1 |
| 长文本 | 多行文本 | 1 |
| 数字 | 数字 | 2 |
| 选项值 | 单选 | 3 |
| 多个选项 | 多选 | 4 |
| 日期时间 | 日期时间 | 5 |
| 布尔值 | 复选框 | 7 |
| URL链接 | 超链接 | 15 |
| 电话号码 | 电话号码 | 13 |

### 分析算法

#### 内容类型检测
```python
def _is_json_content(self, content: str) -> bool:
    """检测内容是否为JSON格式"""
    try:
        json.loads(content)
        return True
    except (json.JSONDecodeError, TypeError):
        return False
```

#### 字段类型推断
```python
def _infer_field_type(self, key: str, value: Any) -> Dict[str, Any]:
    """根据键名和值推断字段类型"""
    # 基于值类型的推断
    if isinstance(value, bool):
        return {"type": "checkbox", "confidence": 0.9}
    elif isinstance(value, (int, float)):
        return {"type": "number", "confidence": 0.8}
    elif isinstance(value, str):
        # 进一步分析字符串内容
        if self._is_url(value):
            return {"type": "url", "confidence": 0.9}
        elif self._is_phone(value):
            return {"type": "phone", "confidence": 0.9}
        # ... 更多类型检测
```

## 配置文件结构

### 生成的模板文件
模板文件保存在 `templates/` 目录下，包含以下信息：

```json
{
  "template_info": {
    "name": "智能字段模板",
    "created_at": "2024-01-01T12:00:00",
    "version": "1.0",
    "description": "基于历史数据分析生成的飞书字段模板"
  },
  "analysis_summary": {
    "analyzed_records": 100,
    "detected_fields": 15,
    "confidence_level": "high",
    "sample_data": ["示例数据1", "示例数据2"]
  },
  "feishu_fields": [
    {
      "field_name": "视频标题",
      "field_type": "text",
      "description": "视频文件的标题信息",
      "required": true,
      "config": {}
    }
  ],
  "field_mapping": {
    "title": "视频标题",
    "duration": "视频时长"
  },
  "setup_instructions": {
    "manual_steps": [
      {
        "step": 1,
        "field_name": "视频标题",
        "field_type": "text",
        "description": "创建文本类型字段，用于存储视频标题"
      }
    ],
    "notes": ["创建字段时请保持字段名称一致", "可根据实际需求调整字段配置"]
  }
}
```

## 错误处理

### 常见错误类型
1. **分析阶段错误**
   - 无历史记录
   - 数据格式不支持
   - 内容结构过于复杂

2. **模板生成错误**
   - 字段类型映射失败
   - 字段数量过多或过少

3. **文件保存错误**
   - 磁盘空间不足
   - 文件写入权限不足
   - 目录不存在

### 错误处理策略
- **友好提示**：提供清晰的错误信息和解决建议
- **日志记录**：记录详细的错误信息便于排查
- **优雅降级**：即使部分功能失败也能提供基础模板

## 最佳实践

### 1. 数据准备
- 确保有足够的历史分析记录（建议至少10条）
- 历史记录应包含多样化的内容类型
- 定期清理无效或错误的历史记录

### 2. 模板使用
- 仔细阅读生成的模板文件和创建指南
- 根据实际业务需求调整字段配置
- 保持字段名称与模板一致以确保同步正常

### 3. 字段创建
- 按照模板中的字段顺序依次创建
- 注意字段类型的正确选择
- 创建完成后进行测试验证

## 扩展功能

### 1. 自定义字段映射
- 支持用户自定义字段名称映射
- 允许调整字段类型推断规则
- 提供字段配置的高级选项

### 2. 模板管理
- 支持保存和加载历史模板
- 提供模板版本管理功能
- 支持模板的导入导出

## 注意事项

1. **数据要求**：需要有足够的历史分析记录作为分析基础
2. **模板文件**：生成的模板文件包含重要配置信息，请妥善保管
3. **手动创建**：需要用户根据模板手动创建飞书字段，确保准确性
4. **字段一致性**：创建的字段名称必须与模板保持一致
5. **性能考虑**：大量历史记录可能影响分析性能，建议适当控制数据量

## 更新日志

### v1.0.0 (2024-01-20)
- 初始版本发布
- 支持基础的智能字段分析和创建
- 支持JSON和文本格式的内容分析
- 支持常见字段类型的自动推断