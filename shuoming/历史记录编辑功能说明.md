# 历史记录编辑功能说明

## 功能概述

历史记录编辑功能允许用户直接在历史记录界面中修改已保存的分析记录内容，包括分析提示和分析结果。这个功能为用户提供了更灵活的内容管理能力。

## 功能特点

### 1. 便捷的编辑入口
- 在历史记录详情区域新增"编辑内容"按钮
- 按钮位置：详情操作按钮区域，位于"同步此记录到飞书"按钮之后
- 只需选择记录并点击按钮即可开始编辑

### 2. 直观的编辑界面
- 弹出式编辑对话框，尺寸为800x600像素
- 模态窗口设计，确保用户专注于编辑任务
- 窗口自动居中显示，提供良好的用户体验

### 3. 完整的内容编辑
- **分析提示编辑**：可修改原始的分析提示内容
- **分析结果编辑**：可修改AI生成的分析结果
- 支持多行文本编辑，带滚动条
- 保持原有的文本格式和换行

### 4. 智能的保存机制
- 自动检测内容是否有修改
- 如果没有修改，提示用户并直接关闭窗口
- 保存前进行二次确认，防止误操作
- 实时更新数据库和界面显示

## 使用方法

### 步骤1：选择记录
1. 打开历史记录界面
2. 在左侧记录列表中选择要编辑的记录
3. 右侧会显示该记录的详细信息

### 步骤2：开始编辑
1. 在右侧详情区域找到"编辑内容"按钮
2. 点击按钮打开编辑对话框
3. 编辑对话框会显示当前记录的完整信息

### 步骤3：修改内容
1. **编辑分析提示**：在上方文本框中修改分析提示内容
2. **编辑分析结果**：在下方文本框中修改分析结果内容
3. 可以修改其中一个或两个字段
4. 支持复制、粘贴等标准文本操作

### 步骤4：保存修改
1. 完成编辑后点击"保存"按钮
2. 系统会检查是否有内容修改
3. 确认保存后，系统会：
   - 更新数据库记录
   - 刷新界面显示
   - 显示保存成功提示
   - 自动关闭编辑窗口

### 步骤5：取消编辑
- 如果不想保存修改，点击"取消"按钮
- 或直接关闭编辑窗口
- 所有修改都不会被保存

## 技术实现

### 界面组件
- **编辑按钮**：添加到历史记录详情操作区域
- **编辑对话框**：使用Tkinter的Toplevel窗口
- **文本编辑器**：使用ScrolledText组件支持多行编辑
- **按钮控件**：保存和取消按钮

### 数据处理
- **记录查找**：通过sequence_id在历史数据中定位记录
- **内容比较**：智能检测修改内容，避免无效更新
- **数据库更新**：使用update_analysis_fields方法更新记录
- **界面刷新**：实时更新本地数据和显示内容

### 核心方法

#### `_edit_record_content()`
- 获取选中记录的sequence_id
- 在历史数据中查找对应记录
- 调用编辑对话框

#### `_open_edit_dialog(record)`
- 创建编辑窗口和界面组件
- 加载当前记录内容到编辑器
- 设置窗口属性和布局

#### `_save_edited_content()`
- 获取编辑后的内容
- 比较原始内容检测修改
- 更新数据库和本地数据
- 刷新界面显示

## 数据库支持

### 更新方法
使用`VideoAnalysisDB.update_analysis_fields()`方法：
```python
update_fields = {
    'analysis_prompt': new_prompt,  # 可选
    'analysis_result': new_result   # 可选
}
success = db.update_analysis_fields(sequence_id, update_fields)
```

### 字段说明
- **analysis_prompt**：分析提示字段
- **analysis_result**：分析结果字段
- **updated_at**：自动更新为当前时间戳

## 安全特性

### 数据保护
- 修改前进行二次确认
- 事务性数据库操作
- 异常处理和错误提示

### 用户体验
- 模态窗口防止误操作
- 智能检测避免无效保存
- 清晰的操作反馈

## 注意事项

### 使用建议
1. **备份重要数据**：编辑前建议导出重要记录
2. **谨慎修改**：确保修改内容的准确性
3. **及时保存**：完成编辑后及时保存

### 限制说明
1. **单条记录编辑**：每次只能编辑一条记录
2. **文本内容限制**：受数据库字段长度限制
3. **并发编辑**：不支持多用户同时编辑同一记录

### 兼容性
- 支持所有现有的历史记录
- 与飞书同步功能完全兼容
- 不影响其他功能的正常使用

## 故障排除

### 常见问题

**Q: 点击编辑按钮没有反应？**
A: 请确保已选择了一条记录，编辑按钮只在选中记录时有效。

**Q: 保存时提示失败？**
A: 可能是数据库连接问题，请检查数据库文件权限或重启应用程序。

**Q: 编辑窗口显示不完整？**
A: 请检查屏幕分辨率，编辑窗口会自动调整到合适位置。

**Q: 修改后界面没有更新？**
A: 保存成功后界面会自动刷新，如果没有更新请手动刷新历史记录。

### 错误处理
- 所有操作都有异常捕获和错误提示
- 数据库操作失败会显示具体错误信息
- 界面操作异常不会影响应用程序稳定性

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现基础编辑功能
- ✅ 添加编辑对话框界面
- ✅ 支持分析提示和结果编辑
- ✅ 实现数据库更新功能
- ✅ 添加智能保存检测
- ✅ 完善错误处理机制

---

*本文档描述了历史记录编辑功能的完整使用方法和技术实现，如有疑问请参考相关代码文件或联系开发团队。*