# 字段映射功能修复说明

## 问题描述

用户反馈软件没有正确调用自定义字段映射功能，导致出现 `FieldNameNotFound` 错误。经检查发现以下问题：

1. **代码未使用自定义字段映射器**：`feishu_sync.py` 中只使用了硬编码的 `FeishuFieldFixer`，没有调用 `CustomFieldMapper`
2. **字段名称不匹配**：自定义字段映射配置中的飞书字段名称与实际飞书表格中的字段名称不一致
3. **映射逻辑缺失**：缺少优先使用自定义映射、回退到默认映射的逻辑

## 修复方案

### 1. 修改 feishu_sync.py

**添加自定义字段映射器导入**：
```python
from .custom_field_mapper import CustomFieldMapper
```

**在初始化方法中添加自定义映射器**：
```python
def __init__(self):
    # ... 其他代码 ...
    self.custom_mapper = CustomFieldMapper()
```

**修改数据准备逻辑**：
实现了优先使用自定义字段映射、失败时回退到默认映射的逻辑：

```python
# 优先使用自定义字段映射器
try:
    field_mappings = self.custom_mapper.get_field_mappings()
    if field_mappings:
        # 使用自定义映射转换数据
        feishu_data = {}
        for raw_field, value in raw_data.items():
            if raw_field in field_mappings:
                feishu_field = field_mappings[raw_field]
                # 数据格式转换逻辑
                # ...
    else:
        # 回退到默认映射
        feishu_data = self.field_fixer.prepare_record_data(raw_data)
except Exception as e:
    # 异常时回退到默认映射
    feishu_data = self.field_fixer.prepare_record_data(raw_data)
```

### 2. 修正字段映射配置

**修改前的配置**（错误）：
```json
{
  "field_mapping": {
    "mappings": {
      "video_serial_number": "视频序列号",
      "video_content_summary": "视频内容摘要",
      "detailed_content_description": "详细内容描述",
      "keywords_tags": "关键词标签",
      "main_characters_objects": "主要人物对象",
      "video_source_path": "视频源路径"
    }
  }
}
```

**修改后的配置**（正确）：
```json
{
  "field_mapping": {
    "mappings": {
      "sequence_id": "序列ID",
      "video_content_summary": "分析结果",
      "detailed_content_description": "分析结果",
      "keywords_tags": "标签",
      "main_characters_objects": "分析结果",
      "video_source_path": "文件路径"
    }
  }
}
```

### 3. 字段名称对应关系

| 数据库字段 | 自定义映射字段 | 飞书表格字段 | 说明 |
|-----------|---------------|-------------|------|
| sequence_id | sequence_id | 序列ID | 视频序列标识 |
| video_content_summary | video_content_summary | 分析结果 | 视频内容摘要 |
| detailed_content_description | detailed_content_description | 分析结果 | 详细内容描述 |
| keywords_tags | keywords_tags | 标签 | 关键词标签 |
| main_characters_objects | main_characters_objects | 分析结果 | 主要人物对象 |
| video_source_path | video_source_path | 文件路径 | 视频源路径 |

## 修复效果

### 1. 功能改进

- ✅ **自动字段映射**：软件现在会优先使用 `shuoming/custom_field_mapping.json` 中的自定义字段映射配置
- ✅ **智能回退机制**：如果自定义映射失败，会自动回退到默认的 `FeishuFieldFixer` 映射
- ✅ **详细日志记录**：提供完整的映射过程日志，便于调试和监控
- ✅ **字段名称匹配**：修正了字段名称，确保与飞书表格中实际存在的字段匹配

### 2. 日志输出示例

**成功使用自定义映射**：
```
✅ 自定义映射: sequence_id -> 序列ID = 20250823192727CACE08E1
✅ 自定义映射: video_content_summary -> 分析结果 = 这是一个关于汽车的视频...
📋 使用自定义字段映射，准备的飞书数据字段: ['序列ID', '分析结果', '标签', '文件路径']
```

**回退到默认映射**：
```
⚠️  未找到自定义字段映射配置，使用默认映射
⚠️  跳过问题字段: video_content_summary -> 视频内容摘要 (单选类型，无法接受文本数据)
```

### 3. 错误处理

- **配置文件不存在**：自动回退到默认映射
- **字段映射为空**：自动回退到默认映射
- **映射过程异常**：捕获异常并回退到默认映射
- **字段名称不匹配**：记录警告日志并跳过该字段

## 使用方法

### 1. 自定义字段映射

编辑 `shuoming/custom_field_mapping.json` 文件：

```json
{
  "field_mapping": {
    "description": "AI模型输出字段到飞书字段的映射关系",
    "mappings": {
      "数据库字段名": "飞书表格字段名",
      "sequence_id": "序列ID",
      "video_content_summary": "分析结果"
    }
  }
}
```

### 2. 验证映射配置

1. 启动软件
2. 分析一个视频文件
3. 查看日志输出，确认使用了自定义映射
4. 检查飞书表格中的数据是否正确同步

### 3. 调试映射问题

如果出现映射问题，检查以下内容：

1. **配置文件格式**：确保 JSON 格式正确
2. **字段名称**：确保飞书表格中存在对应的字段
3. **字段类型**：确保飞书字段类型支持文本数据
4. **日志输出**：查看详细的映射过程日志

## 技术细节

### 1. 映射优先级

1. **自定义字段映射**：优先使用 `CustomFieldMapper`
2. **默认字段映射**：回退使用 `FeishuFieldFixer`
3. **问题字段跳过**：跳过配置错误的字段（如附件类型）

### 2. 数据转换逻辑

```python
# 数据格式转换
if value is not None:
    if isinstance(value, (dict, list)):
        converted_value = json.dumps(value, ensure_ascii=False)
    else:
        converted_value = str(value)
else:
    converted_value = ""
```

### 3. 错误处理机制

- **配置加载失败**：记录错误并使用默认配置
- **字段映射失败**：记录警告并跳过该字段
- **数据转换失败**：记录错误并使用空字符串

## 注意事项

1. **字段名称必须完全匹配**：飞书表格中的字段名称必须与配置文件中的完全一致
2. **字段类型限制**：飞书字段必须支持文本类型数据
3. **配置文件备份**：修改配置前建议备份原文件
4. **测试验证**：修改配置后务必进行测试验证

---

**修复时间**：2025年1月  
**影响范围**：飞书数据同步功能  
**修复文件**：
- `src/utils/feishu_sync.py`
- `shuoming/custom_field_mapping.json`