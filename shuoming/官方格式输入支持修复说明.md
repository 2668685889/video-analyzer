# 官方格式输入支持修复说明

## 问题描述

用户提供了官方的输入格式，该格式与之前处理的格式不同：

```json
{
  "items": [
    {
      "fields": "{\"单选\":\"选项 1\",\"文本\":[{\"text\":\"文本内容\",\"type\":\"text\"}],\"日期\":1674206443000}",
      "record_id": "recuIlzQPYAErm"
    },
    {
      "fields": "{}",
      "record_id": "recuIlzQPY9iOF"
    }
    // ... 更多items
  ]
}
```

### 主要问题

1. **新的数据结构**：输入包含 `items` 数组，每个item包含 `fields` 和 `record_id`
2. **字段名不匹配**：官方格式使用 "单选"、"文本"、"日期" 等字段名，与原有映射不匹配
3. **复杂的字段值结构**："文本" 字段包含复杂的数组结构，需要提取 `text` 值
4. **空字段处理**：某些item的 `fields` 为空对象 `{}`

## 修复方案

### 1. 新增 `_process_items_format` 方法

```python
def _process_items_format(self, input_data):
    """
    处理包含items数组的官方输入格式
    """
    try:
        items = input_data.get("items", [])
        result_list = []
        
        for item in items:
            if isinstance(item, dict) and "fields" in item:
                # 处理每个item中的fields格式
                processed_items = self._process_fields_format(item)
                result_list.extend(processed_items)
            else:
                # 如果不是预期格式，直接添加
                result_list.append(item)
        
        return result_list
        
    except Exception as e:
        # 如果解析失败，返回原始数据
        return [input_data]
```

### 2. 扩展字段映射支持

更新 `field_mapping` 以支持官方格式的字段名：

```python
self.field_mapping = {
    # 原有的中文字段映射
    "视频序列号": "video_serial_number",
    "视频内容摘要": "video_content_summary", 
    "详细内容描述": "detailed_content_description",
    "关键词标签": "keyword_tags",
    "主要对象": "main_objects",
    
    # 官方格式字段映射
    "单选": "video_serial_number",
    "文本": "video_content_summary",
    "日期": "detailed_content_description",
    
    # 英文字段映射（直接映射）
    "video_serial_number": "video_serial_number",
    "video_content_summary": "video_content_summary",
    "detailed_content_description": "detailed_content_description",
    "keyword_tags": "keyword_tags",
    "main_objects": "main_objects"
}
```

### 3. 增强字段值处理

新增 `_process_field_value` 方法来处理复杂的字段值结构：

```python
def _process_field_value(self, value):
    """
    处理字段值，提取有用信息
    """
    if value is None:
        return ""
    
    # 如果是列表，尝试提取text值
    if isinstance(value, list) and len(value) > 0:
        first_item = value[0]
        if isinstance(first_item, dict) and "text" in first_item:
            return str(first_item["text"])
        else:
            return str(first_item)
    
    # 如果是字典，尝试提取text值
    elif isinstance(value, dict):
        if "text" in value:
            return str(value["text"])
        else:
            if value:
                return str(list(value.values())[0])
            else:
                return ""
    
    # 其他类型直接转换为字符串
    else:
        return str(value)
```

### 4. 优化字段提取逻辑

重构 `_extract_field_value` 方法，使其能够：
- 通过字段映射查找对应的源字段名
- 正确处理复杂的字段值结构
- 支持多种字段名格式

### 5. 增强输入处理逻辑

在 `_process_input` 方法中添加对官方格式的检测：

```python
# 如果输入已经是字典，检查是否包含特殊格式
elif isinstance(input_data, dict):
    # 检查是否是包含items数组的官方格式
    if "items" in input_data:
        return self._process_items_format(input_data)
    # 检查是否是包含fields和record_id的特殊格式
    elif "fields" in input_data:
        return self._process_fields_format(input_data)
    else:
        return [input_data]
```

## 修复效果

### 处理前
- 无法识别官方格式的 `items` 数组结构
- 字段映射失败，所有输出字段为空
- 无法处理复杂的字段值结构

### 处理后
- ✅ 正确识别和处理 `items` 数组格式
- ✅ 成功映射官方字段名到目标字段
- ✅ 正确提取复杂结构中的 `text` 值
- ✅ 妥善处理空 `fields` 的情况
- ✅ 保持向后兼容性

### 测试结果示例

```json
{
  "main_objects": [
    {
      "video_serial_number": "选项 1",
      "video_content_summary": "文本内容",
      "detailed_content_description": "1674206443000",
      "keyword_tags": "",
      "main_objects": ""
    },
    {
      "video_serial_number": "选项 1",
      "video_content_summary": "另一个文本内容",
      "detailed_content_description": "1674206443000",
      "keyword_tags": "",
      "main_objects": ""
    }
  ],
  "status": "success",
  "message": "数据处理成功"
}
```

## 支持的输入格式

现在代码支持以下多种输入格式：

1. **官方格式**：包含 `items` 数组的格式
2. **单个Fields格式**：包含 `fields` 和 `record_id` 的单个对象
3. **标准JSON格式**：直接的键值对格式
4. **数组格式**：包含多个对象的数组
5. **字符串格式**：JSON字符串或键值对字符串

## 技术特性

- **多格式支持**：自动检测和处理不同的输入格式
- **智能字段映射**：支持多种字段名到标准字段的映射
- **复杂值处理**：能够从嵌套结构中提取有用信息
- **容错性强**：对空字段和异常情况有良好的处理
- **向后兼容**：不影响原有格式的处理

## 相关文件

- `input_format_adapter.py` - 主要修复文件
- `test_official_format_input.py` - 官方格式测试脚本
- `debug_official_format.py` - 调试脚本

## 总结

通过这次修复，代码现在能够完全支持官方提供的输入格式，成功解决了字段映射和数据提取的问题。用户提供的官方格式数据现在可以正确处理并输出预期的结果。