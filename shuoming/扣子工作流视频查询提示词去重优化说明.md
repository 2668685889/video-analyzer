# 扣子工作流视频查询提示词去重优化说明

## 问题背景

用户反映现有的视频查询提示词存在输出逻辑问题，主要表现为：
1. **重复输出问题**：始终输出相同的视频，缺乏多样性
2. **查询逻辑缺陷**：没有对【唯一标识】进行筛查，导致重复内容
3. **匹配策略不完善**：查询优先级和去重机制不明确

## 优化方案

### 1. 查询逻辑重构

**原有逻辑问题：**
- 缺乏明确的查询优先级
- 没有去重验证机制
- 匹配策略单一

**优化后逻辑：**
```
第一步：标签精准匹配 → 从【核心标签】中查找
第二步：内容语义匹配 → 从【视频内容介绍】中查找
第三步：唯一性验证 → 使用【唯一标识】去重
```

### 2. 去重机制设计

#### 核心原理
- **唯一标识追踪**：建立已选择视频的【唯一标识】列表
- **预检查机制**：每选择视频前检查其【唯一标识】是否已存在
- **跳过重复项**：如果已存在，跳过该视频继续查找
- **强制约束**：确保最终输出的视频都具有不同的【唯一标识】

#### 实现步骤
```markdown
1. 初始化空的去重列表：uniqueIds = []
2. 遍历匹配结果：
   - 检查当前视频的【唯一标识】
   - 如果不在uniqueIds中，添加到结果和uniqueIds
   - 如果已存在，跳过继续下一个
3. 重复直到获得10个不重复的视频或无更多匹配
```

### 3. 查询执行优化

#### 三轮查询策略

**第一轮：标签精准匹配**
- 目标：从【核心标签】中查找包含输入关键词的视频
- 优势：匹配精度高，相关性强
- 去重：记录匹配视频的【唯一标识】

**第二轮：内容语义匹配**
- 触发条件：标签匹配结果不足10条
- 目标：从【视频内容介绍】中查找语义相关内容
- 去重：跳过已选择的【唯一标识】

**第三轮：最终验证**
- 检查所有选中视频的【唯一标识】
- 确保无重复项
- 按匹配度重新排序

### 4. 输出格式改进

#### 新增字段说明

**【匹配逻辑】字段优化：**
```markdown
原格式：【匹配逻辑】：标签匹配：{关键词}在核心标签中
新格式：【匹配逻辑】：{匹配方式} - {具体匹配内容}

示例：
- 【匹配逻辑】：标签匹配 - "飞坡测试"在核心标签中精确匹配
- 【匹配逻辑】：内容匹配 - "腾空"概念在详细描述中体现为"离地瞬间"
```

**分割线统一：**
- 每个视频记录后添加 `---` 分割线
- 保持与云文档同步格式一致
- 提高输出内容的可读性

### 5. 约束机制强化

#### 致命约束升级

**原有约束：**
- 禁止虚构
- 格式锁死

**新增约束：**
- **去重强制**：严禁输出相同【唯一标识】的视频
- **数量限制**：最多输出10条不重复的匹配视频
- **去重检查**：若发现重复需重新执行查询流程

#### 错误处理机制

```markdown
情况1：无匹配结果
输出："未找到匹配视频（知识库现有标签：[前3个标签] ，可调整需求关键词重试）"

情况2：匹配结果不足10条
输出：实际匹配的视频数量，不强制凑够10条

情况3：发现重复【唯一标识】
处理：自动跳过重复项，继续查找下一个匹配项
```

## 技术要点

### 1. 去重算法设计

```python
# 伪代码示例
def deduplicate_videos(matched_videos):
    unique_videos = []
    seen_ids = set()
    
    for video in matched_videos:
        video_id = video['唯一标识']
        if video_id not in seen_ids:
            unique_videos.append(video)
            seen_ids.add(video_id)
            
            if len(unique_videos) >= 10:
                break
    
    return unique_videos
```

### 2. 查询优先级实现

```markdown
优先级权重：
1. 标签完全匹配：权重 100
2. 标签部分匹配：权重 80
3. 内容核心摘要匹配：权重 60
4. 内容详细描述匹配：权重 40
5. 语义相关匹配：权重 20
```

### 3. 匹配逻辑追踪

每个输出视频都明确标注匹配方式：
- **标签匹配**：直接从核心标签中找到关键词
- **内容匹配**：从视频内容介绍中找到相关描述
- **语义匹配**：通过语义理解找到相关内容

## 优化效果

### 1. 解决重复输出问题

**优化前：**
- 可能输出多个相同【唯一标识】的视频
- 结果缺乏多样性
- 用户体验差

**优化后：**
- 严格保证【唯一标识】不重复
- 提供多样化的视频选择
- 提升查询结果质量

### 2. 提升匹配精度

**查询策略优化：**
- 标签精准匹配优先，确保高相关性
- 内容语义匹配补充，扩大匹配范围
- 三轮验证机制，确保结果质量

**匹配逻辑透明化：**
- 明确标注每个视频的匹配方式
- 便于用户理解匹配逻辑
- 方便后续优化和调试

### 3. 增强系统稳定性

**错误处理完善：**
- 无匹配结果时提供明确提示
- 重复检测机制防止逻辑错误
- 数量限制避免输出过载

**约束机制强化：**
- 多层约束确保输出质量
- 强制去重避免重复内容
- 格式统一保持一致性

## 使用指南

### 1. 部署步骤

1. **替换提示词**
   - 将 `优化后的视频查询提示词-去重版.txt` 内容复制到扣子工作流
   - 替换原有的提示词配置

2. **验证配置**
   - 确认变量 `input` 正确关联
   - 检查技能绑定的知识库
   - 测试去重机制是否生效

3. **测试验证**
   - 使用相同关键词多次查询
   - 检查输出结果的【唯一标识】是否重复
   - 验证匹配逻辑是否正确标注

### 2. 监控要点

**关键指标：**
- 【唯一标识】重复率：应为0%
- 匹配结果多样性：不同查询应返回不同视频组合
- 匹配逻辑准确性：标注的匹配方式应与实际一致

**异常处理：**
- 如发现重复【唯一标识】，检查去重逻辑
- 如匹配结果单一，检查查询策略
- 如输出格式错误，检查约束机制

### 3. 优化建议

**短期优化：**
- 根据实际使用情况调整匹配权重
- 优化关键词提取和语义理解
- 完善错误提示信息

**长期优化：**
- 增加用户反馈机制
- 实现动态权重调整
- 支持更复杂的查询逻辑

## 文件清单

### 创建的文件

1. **优化提示词：** `扣子工作流/优化后的视频查询提示词-去重版.txt`
   - 可直接复制到扣子工作流使用
   - 包含完整的去重逻辑和查询策略

2. **技术文档：** `shuoming/扣子工作流视频查询提示词去重优化说明.md`
   - 详细的优化说明和技术要点
   - 使用指南和监控建议

### 相关文件

- `扣子工作流/视频查询大模型节点提示词.md`：原始技术文档
- `扣子工作流/扣子工作流提示词-直接使用版.txt`：原始提示词版本

## 总结

通过引入严格的去重机制和优化查询逻辑，成功解决了视频查询提示词的重复输出问题。新版本提示词具有以下特点：

1. **去重保证**：严格的【唯一标识】检查机制
2. **查询优化**：三轮查询策略提升匹配精度
3. **逻辑透明**：明确标注每个视频的匹配方式
4. **约束强化**：多层约束确保输出质量
5. **错误处理**：完善的异常情况处理机制

**实施状态：** ✅ 已完成  
**测试状态：** 待验证  
**部署状态：** 可立即使用