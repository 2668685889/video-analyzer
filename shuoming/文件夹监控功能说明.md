# 文件夹监控功能说明

## 功能概述

文件夹监控功能是Nova Quest视频分析系统的一个重要特性，它能够实时监控指定文件夹中的视频文件变化，当检测到新的视频文件时，可以自动触发分析功能，实现无人值守的自动化视频分析。

## 主要特性

### 1. 实时文件监控
- **实时检测**：使用watchdog库实现文件系统的实时监控
- **递归监控**：支持监控文件夹及其所有子文件夹
- **智能过滤**：只监控支持的视频格式文件（mp4, avi, mov, mkv, webm）
- **文件完整性检测**：等待文件写入完成后再触发处理

### 2. 自动分析功能
- **自动触发**：检测到新文件时自动开始分析
- **智能判断**：检查是否设置了分析提示词
- **状态提示**：实时显示分析进度和状态
- **错误处理**：处理分析过程中的各种异常情况

### 3. 用户界面控制
- **监控开关**：一键启动/停止文件夹监控
- **自动分析开关**：控制是否自动分析新检测到的文件
- **状态显示**：实时显示监控状态和监控的文件夹信息
- **颜色指示**：通过不同颜色显示监控状态（绿色=运行中，灰色=已停止，橙色=警告）

## 使用方法

### 1. 添加监控文件夹
1. 点击"选择文件夹"按钮
2. 选择包含视频文件的文件夹
3. 系统会自动扫描文件夹中的视频文件并添加到列表
4. 文件夹会自动添加到监控列表中

### 2. 启用监控功能
1. 勾选"启用文件夹监控"复选框
2. 系统会开始监控已添加的文件夹
3. 监控状态会显示为"正在监控文件夹: [文件夹名称]"

### 3. 启用自动分析
1. 在提示词区域输入分析提示词
2. 勾选"检测到新文件时自动分析"复选框
3. 当检测到新文件时，系统会自动使用设置的提示词进行分析

### 4. 监控状态管理
- **启动监控**：勾选监控开关，系统开始实时监控
- **停止监控**：取消勾选监控开关，系统停止监控
- **状态查看**：通过状态标签查看当前监控状态

## 技术实现

### 1. 核心模块
- **文件路径**：`src/utils/folder_monitor.py`
- **主要类**：
  - `FolderMonitor`：文件夹监控器主类
  - `VideoFileHandler`：视频文件事件处理器

### 2. 关键方法

#### FolderMonitor类
```python
# 添加监控文件夹
add_folder(folder_path: str) -> bool

# 开始监控
start_monitoring() -> bool

# 停止监控
stop_monitoring()

# 设置回调函数
set_file_callback(callback: Callable[[str], None])
set_status_callback(callback: Callable[[str], None])
```

#### VideoFileHandler类
```python
# 文件创建事件处理
on_created(event)

# 文件移动事件处理
on_moved(event)

# 检查是否为视频文件
is_video_file(file_path: str) -> bool
```

### 3. 主界面集成
- **UI组件**：在文件选择区域添加监控控制组件
- **事件处理**：实现监控开关和自动分析的事件处理
- **状态更新**：实时更新监控状态显示
- **线程安全**：使用`root.after()`确保UI更新在主线程中执行

## 工作流程

### 1. 监控启动流程
1. 用户选择文件夹并添加到监控列表
2. 用户启用文件夹监控
3. 系统创建watchdog观察者并开始监控
4. 状态显示更新为"正在监控"

### 2. 文件检测流程
1. 文件系统发生变化（新建或移动文件）
2. VideoFileHandler检测到事件
3. 验证文件是否为支持的视频格式
4. 等待文件写入完成
5. 触发文件回调函数

### 3. 自动分析流程
1. 检测到新视频文件
2. 将文件添加到文件列表
3. 检查是否启用自动分析
4. 验证是否设置了分析提示词
5. 自动开始分析过程
6. 显示分析结果

## 配置选项

### 1. 监控设置
- **递归监控**：默认启用，监控子文件夹
- **文件完整性检测**：默认30秒超时
- **支持格式**：从config模块获取支持的视频格式

### 2. 自动分析设置
- **提示词检查**：分析前验证是否设置提示词
- **错误处理**：分析失败时显示错误信息
- **状态更新**：实时显示分析进度

## 优势特点

### 1. 高效性能
- **事件驱动**：基于文件系统事件，响应迅速
- **资源优化**：只在文件变化时触发处理
- **多线程**：监控和分析在独立线程中运行

### 2. 智能处理
- **格式过滤**：只处理支持的视频格式
- **重复检测**：避免重复处理同一文件
- **完整性验证**：确保文件写入完成后再处理

### 3. 用户友好
- **直观界面**：简单的开关控制
- **状态反馈**：实时显示监控和分析状态
- **错误提示**：清晰的错误信息和处理建议

## 使用场景

### 1. 批量视频处理
- **监控下载文件夹**：自动处理下载的视频文件
- **网络共享文件夹**：监控网络存储中的新视频
- **定时任务配合**：与定时任务结合实现自动化处理

### 2. 实时分析需求
- **监控摄像头录制**：实时分析新录制的视频
- **直播回放处理**：自动分析保存的直播片段
- **安全监控分析**：自动分析监控视频内容

### 3. 工作流自动化
- **内容审核**：自动审核上传的视频内容
- **数据分析**：批量分析视频数据并生成报告
- **质量检测**：自动检测视频质量和内容合规性

## 注意事项

### 1. 性能考虑
- **文件夹大小**：监控大量文件的文件夹可能影响性能
- **网络文件夹**：监控网络文件夹可能有延迟
- **系统资源**：长时间监控会占用一定系统资源

### 2. 使用建议
- **合理设置提示词**：确保自动分析的准确性
- **定期清理**：及时清理已处理的文件避免重复处理
- **监控范围**：避免监控过大的文件夹影响性能

### 3. 故障排除
- **权限问题**：确保对监控文件夹有读取权限
- **格式支持**：确认文件格式在支持列表中
- **网络连接**：自动分析需要稳定的网络连接

## 更新日志

### v1.0.0 (2024-01-XX)
- ✅ 实现基础文件夹监控功能
- ✅ 添加自动分析触发机制
- ✅ 集成用户界面控制组件
- ✅ 实现状态显示和错误处理
- ✅ 支持递归文件夹监控
- ✅ 添加文件完整性检测
- ✅ 实现线程安全的UI更新

---

**开发团队**：唐山肖川科技  
**文档版本**：1.0.0  
**最后更新**：2024年1月