# 文件夹监控功能错误修复说明

## 错误描述

在文件夹监控功能中，当检测到新文件并尝试自动分析时，出现以下错误：

```
AttributeError: 'MainWindow' object has no attribute 'prompt_text'
```

## 错误原因

在 `MainWindow` 类的 `_handle_new_file_in_main_thread` 方法中，代码尝试访问 `self.prompt_text` 属性来获取当前的分析提示词：

```python
current_prompt = self.prompt_text.get("1.0", tk.END).strip()
```

但是，在重构UI界面时，原来的自定义提示输入框已被移除，改为使用快速提示管理器。因此 `prompt_text` 属性不再存在，导致了 `AttributeError`。

## 修复方案

将获取提示词的代码修改为使用快速提示管理器的 `get_selected_prompt_text()` 方法：

### 修复前：
```python
current_prompt = self.prompt_text.get("1.0", tk.END).strip()
```

### 修复后：
```python
current_prompt = self.quick_prompts_manager.get_selected_prompt_text()
```

## 修复位置

**文件：** `src/ui/main_window.py`  
**方法：** `_handle_new_file_in_main_thread`  
**行号：** 第1339行

## 修复效果

修复后，文件夹监控功能能够正常工作：

1. **正常检测新文件**：当监控的文件夹中有新的视频文件时，系统能够正确检测到
2. **正确获取提示词**：通过快速提示管理器获取当前选中的分析提示词
3. **自动分析功能**：如果启用了自动分析且设置了提示词，系统会自动开始分析新文件
4. **错误提示**：如果未设置提示词，系统会显示友好的警告信息

## 测试验证

修复后重新启动应用程序，确认：

- ✅ 应用程序正常启动，无错误信息
- ✅ 文件夹监控功能可以正常开启
- ✅ 检测到新文件时不再出现 AttributeError
- ✅ 自动分析功能按预期工作

## 相关文件

- `src/ui/main_window.py` - 主窗口类，包含文件夹监控逻辑
- `src/ui/quick_prompts.py` - 快速提示管理器
- `src/utils/folder_monitor.py` - 文件夹监控核心功能

## 注意事项

1. **代码一致性**：确保所有获取提示词的地方都使用快速提示管理器的方法
2. **错误处理**：在自动分析时要检查提示词是否为空
3. **用户体验**：提供清晰的错误提示和状态反馈

---

**修复时间：** 2025-01-24  
**修复版本：** v1.0.0  
**修复状态：** ✅ 已完成