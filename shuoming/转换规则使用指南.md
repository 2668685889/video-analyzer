# 转换规则使用指南

## 概述

转换规则用于在数据映射过程中对字段值进行预处理和格式化。本指南将详细介绍如何配置和使用转换规则。

## 支持的规则类型

### 1. split（分割规则）

**用途**：将文本按指定分隔符分割，并限制项目数量。

**参数**：
- `separator`（分隔符）：用于分割文本的字符，默认为逗号（,）
- `max_items`（最大项目数）：分割后保留的最大项目数，默认为10

**示例配置**：
```
字段名: video_tags
规则类型: split
分隔符: ,
最大项目数: 5
```

**效果**：
- 输入："科技,教育,娱乐,体育,新闻,财经"
- 输出："科技,教育,娱乐,体育,新闻"（只保留前5个标签）

### 2. format（格式化规则）

**用途**：按指定模板格式化字段值。

**参数**：
- `template`（格式模板）：格式化模板，使用{value}表示原始值

**示例配置**：
```
字段名: video_duration
规则类型: format
格式模板: 时长：{value}分钟
```

**效果**：
- 输入："15"
- 输出："时长：15分钟"

### 3. validate（验证规则）

**用途**：验证字段值是否符合指定模式。

**参数**：
- `pattern`（验证规则）：正则表达式模式或验证条件

**示例配置**：
```
字段名: video_id
规则类型: validate
验证规则: ^[A-Za-z0-9_-]+$
```

**效果**：验证视频ID是否只包含字母、数字、下划线和连字符。

### 4. transform（转换规则）

**用途**：对文本进行基本转换操作。

**参数**：
- `function`（转换函数）：转换函数类型
  - `upper`：转换为大写
  - `lower`：转换为小写
  - `title`：转换为标题格式（首字母大写）
  - `strip`：去除首尾空格

**示例配置**：
```
字段名: video_category
规则类型: transform
转换函数: title
```

**效果**：
- 输入："technology"
- 输出："Technology"

## 如何填写转换规则

### 步骤1：选择字段
1. 在"转换规则"标签页中点击"添加规则"
2. 在"字段名"中输入要应用规则的AI字段名称
3. 确保字段名与"AI字段"标签页中定义的字段名完全一致

### 步骤2：选择规则类型
1. 从"规则类型"下拉菜单中选择合适的规则类型
2. 根据数据处理需求选择：
   - 需要分割长文本 → 选择 `split`
   - 需要格式化显示 → 选择 `format`
   - 需要验证格式 → 选择 `validate`
   - 需要文本转换 → 选择 `transform`

### 步骤3：配置参数
1. 根据选择的规则类型，系统会自动显示相应的参数设置
2. 填写必要的参数值
3. 参数值支持自动类型转换（数字、布尔值等）

### 步骤4：保存规则
1. 点击"确定"保存规则
2. 规则将显示在转换规则列表中
3. 点击"保存配置"保存整个配置

## 如何验证转换规则

### 方法1：使用测试映射功能

1. **配置完成后测试**：
   - 在配置编辑器底部点击"测试映射"按钮
   - 系统会自动生成测试数据
   - 查看"映射结果"部分，确认转换规则是否按预期工作

2. **测试数据说明**：
   - 系统根据AI字段定义自动生成测试数据
   - 文本字段：生成"测试+字段描述"的文本
   - 数字字段：生成数字123
   - 其他类型：生成"测试数据"文本

3. **结果验证**：
   - 对比"测试数据"和"映射结果"
   - 检查转换规则是否正确应用
   - 验证输出格式是否符合预期

### 方法2：在实际使用中验证

1. **保存配置**：
   - 确保配置已正确保存
   - 在主程序中加载该配置

2. **实际数据测试**：
   - 使用真实的AI分析结果进行测试
   - 观察飞书同步的数据是否按规则转换
   - 检查飞书表格中的数据格式

3. **调试和优化**：
   - 如果结果不符合预期，返回配置界面修改规则
   - 重新测试直到达到预期效果

## 常见使用场景

### 场景1：视频标签处理
```
问题：AI返回的标签过多，需要限制数量
解决方案：
- 字段名: video_tags
- 规则类型: split
- 分隔符: ,
- 最大项目数: 5
```

### 场景2：内容摘要长度控制
```
问题：摘要文本过长，需要截断
解决方案：
- 字段名: video_summary
- 规则类型: format
- 格式模板: {value}（如果需要添加前缀或后缀）
注：长度控制需要在代码层面实现
```

### 场景3：分类标准化
```
问题：分类名称需要统一格式
解决方案：
- 字段名: video_category
- 规则类型: transform
- 转换函数: title
```

### 场景4：ID格式验证
```
问题：确保ID符合特定格式
解决方案：
- 字段名: video_id
- 规则类型: validate
- 验证规则: ^[A-Za-z0-9_-]+$
```

## 注意事项

1. **字段名匹配**：转换规则的字段名必须与AI字段中定义的字段名完全一致

2. **规则顺序**：如果同一字段有多个规则，按添加顺序依次执行

3. **错误处理**：如果转换规则执行失败，系统会返回原始值并记录错误日志

4. **性能考虑**：复杂的转换规则可能影响处理速度，建议适度使用

5. **测试重要性**：每次修改规则后都应该进行测试，确保规则按预期工作

## 故障排除

### 问题1：转换规则不生效
**可能原因**：
- 字段名不匹配
- 规则参数配置错误
- 配置未保存

**解决方法**：
- 检查字段名是否与AI字段一致
- 验证参数配置
- 重新保存配置并测试

### 问题2：测试映射失败
**可能原因**：
- 配置格式错误
- 缺少必要字段
- 规则参数无效

**解决方法**：
- 使用"验证配置"功能检查配置
- 确保AI字段和飞书映射都已配置
- 检查转换规则参数的有效性

### 问题3：实际使用中转换异常
**可能原因**：
- 实际数据格式与预期不符
- 转换规则过于严格
- 数据类型不匹配

**解决方法**：
- 检查实际AI返回的数据格式
- 调整转换规则参数
- 添加数据类型检查和容错处理

通过本指南，您应该能够熟练配置和使用转换规则，实现数据的精确处理和格式化。