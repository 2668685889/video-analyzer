# 飞书API问题排查指南

## 问题概述

当本地数据处理完全正常（通过率100%），但飞书同步仍然失败时，问题通常出现在飞书API层面。最常见的错误是 `AttachFieldConvFail`，表示字段附加转换失败。

## AttachFieldConvFail 错误分析

### 错误含义
`AttachFieldConvFail` 是飞书多维表格API返回的错误码，表示在尝试更新记录时，某个字段的数据转换或附加操作失败。

### 常见原因

#### 1. 字段类型不匹配
- **问题**：发送的数据类型与飞书字段定义不符
- **示例**：向数字字段发送文本数据，或向单选字段发送多个值
- **解决方案**：检查飞书表格中每个字段的类型设置

#### 2. 字段名称错误
- **问题**：API请求中的字段名在飞书表格中不存在
- **示例**：字段名拼写错误、大小写不匹配、包含特殊字符
- **解决方案**：确保字段名完全匹配飞书表格中的定义

#### 3. 数据格式错误
- **问题**：数据格式不符合飞书API要求
- **示例**：日期格式错误、JSON结构不正确
- **解决方案**：按照飞书API文档格式化数据

#### 4. 字段权限问题
- **问题**：当前用户或应用没有权限修改某些字段
- **示例**：只读字段、受保护字段、权限不足
- **解决方案**：检查字段权限设置和应用权限

#### 5. 数据长度超限
- **问题**：文本字段内容超过飞书限制
- **示例**：单行文本超过1000字符、多行文本超过10000字符
- **解决方案**：截断或分段处理长文本

## 排查步骤

### 第一步：验证字段设置

1. **登录飞书多维表格**
   - 打开对应的多维表格
   - 检查所有字段是否存在
   - 确认字段名称完全匹配

2. **检查字段类型**
   ```
   当前配置的字段类型：
   - 视频序列号: text
   - 视频内容摘要: text  
   - 详细内容描述: text
   - 关键词标签: text
   - 主要对象: text
   ```

3. **验证字段权限**
   - 确保字段不是只读状态
   - 检查应用是否有编辑权限

### 第二步：检查数据内容

1. **数据长度检查**
   ```python
   # 检查各字段数据长度
   for field, value in data.items():
       if isinstance(value, str) and len(value) > 1000:
           print(f"字段 {field} 数据过长: {len(value)} 字符")
   ```

2. **特殊字符检查**
   - 检查是否包含不支持的特殊字符
   - 验证编码格式是否正确

### 第三步：API权限验证

1. **检查应用权限**
   - 确认应用有多维表格的读写权限
   - 验证token是否有效且未过期

2. **测试API连接**
   ```python
   # 简单的API连接测试
   response = feishu_client.get_table_info(table_id)
   if response.status_code == 200:
       print("API连接正常")
   else:
       print(f"API连接失败: {response.status_code}")
   ```

### 第四步：逐字段测试

1. **单字段更新测试**
   - 尝试只更新一个字段
   - 逐个字段测试，找出问题字段

2. **数据简化测试**
   - 使用简单的测试数据
   - 逐步增加数据复杂度

## 常见解决方案

### 方案1：重新创建字段
如果字段设置有问题，可以：
1. 备份现有数据
2. 删除问题字段
3. 重新创建字段（确保类型和名称正确）
4. 恢复数据

### 方案2：调整数据格式
```python
# 数据预处理示例
def preprocess_data(data):
    processed = {}
    for key, value in data.items():
        if isinstance(value, str):
            # 限制文本长度
            if len(value) > 1000:
                value = value[:997] + "..."
            # 清理特殊字符
            value = value.replace('\n', ' ').replace('\r', '')
        processed[key] = value
    return processed
```

### 方案3：分批处理
如果数据量大，可以分批更新：
```python
# 分批更新示例
def batch_update(records, batch_size=10):
    for i in range(0, len(records), batch_size):
        batch = records[i:i+batch_size]
        try:
            update_batch(batch)
        except Exception as e:
            print(f"批次 {i//batch_size + 1} 更新失败: {e}")
```

## 调试工具

### 启用详细日志
在 `.env` 文件中添加：
```
DEBUG_MODE=true
LOG_LEVEL=DEBUG
```

### 使用飞书API调试工具
- 飞书开发者控制台的API调试功能
- Postman等API测试工具
- 飞书官方SDK的调试模式

## 预防措施

1. **定期备份**：定期备份飞书表格数据
2. **权限管理**：合理设置字段和应用权限
3. **数据验证**：在发送前验证数据格式和长度
4. **错误处理**：实现完善的错误处理和重试机制
5. **监控告警**：设置API调用失败的监控告警

## 联系支持

如果以上方法都无法解决问题，可以：
1. 查看飞书开发者文档的最新更新
2. 联系飞书技术支持
3. 在飞书开发者社区寻求帮助
4. 检查是否有API版本更新或变更

---

**注意**：本指南基于当前的错误分析，实际问题可能因具体环境而异。建议按照排查步骤逐一验证，找出具体的问题原因。