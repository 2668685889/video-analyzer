# 飞书电子表格同步功能使用说明

## 功能概述

飞书电子表格同步功能允许用户将视频分析结果自动同步到飞书电子表格中，方便团队协作和数据管理。该功能支持实时同步、批量同步和历史记录管理。

## 配置要求

### 1. 飞书应用配置

在使用同步功能前，需要在飞书开放平台创建应用并获取以下信息：

- **App ID**：飞书应用的唯一标识
- **App Secret**：飞书应用的密钥
- **电子表格Token**：目标电子表格的唯一标识
- **工作表ID**：目标工作表的ID

### 2. 权限配置

确保飞书应用具有以下权限：
- `sheets:spreadsheet` - 电子表格读写权限
- `drive:drive` - 云文档访问权限

### 3. 电子表格结构

目标电子表格应包含以下列（按顺序）：

| 列 | 字段名称 | 说明 |
|---|---|---|
| A | 视频序列号 | 系统生成的唯一标识 |
| B | 文件名称 | 视频文件名 |
| C | 视频内容摘要 | AI生成的内容摘要 |
| D | 详细内容描述 | AI生成的详细描述 |
| E | 关键词标签 | 提取的关键词 |
| F | 主要对象 | 识别的主要对象 |
| G | 分析时间 | 视频分析完成时间 |
| H | 同步时间 | 数据同步到电子表格的时间 |
| I | 同步状态 | 同步状态标识 |

## 使用方法

### 1. 配置同步设置

1. 打开应用主界面
2. 点击 **⚙️ 设置** 按钮
3. 在设置界面中找到 **飞书电子表格配置** 部分
4. 填写以下信息：
   - App ID
   - App Secret
   - 电子表格Token
   - 工作表ID
5. 点击 **测试连接** 验证配置是否正确
6. 点击 **保存配置** 保存设置

### 2. 自动同步

当启用自动同步功能后，每次视频分析完成都会自动将结果同步到电子表格：

1. 在设置界面中勾选 **启用自动同步到电子表格**
2. 完成视频分析后，系统会自动将结果同步到电子表格
3. 同步成功后会显示确认消息

### 3. 手动同步

#### 3.1 同步单条记录

1. 打开 **📋 历史记录** 界面
2. 在记录列表中选择要同步的记录
3. 点击 **同步到电子表格** 按钮
4. 等待同步完成确认

#### 3.2 批量同步

1. 打开 **📋 历史记录** 界面
2. 使用复选框选择多条记录
3. 点击 **同步选中记录到电子表格** 按钮
4. 系统会逐条处理选中的记录

#### 3.3 同步所有记录

1. 打开 **📋 历史记录** 界面
2. 点击 **同步所有内容到电子表格** 按钮
3. 系统会同步所有未同步的记录

### 4. 同步状态监控

系统提供详细的同步状态监控：

- **同步进度**：显示当前同步进度
- **成功计数**：已成功同步的记录数
- **失败计数**：同步失败的记录数
- **错误信息**：详细的错误信息和解决建议

## 数据格式说明

### 1. 分析结果格式

为了正确提取和同步数据，AI分析结果应采用以下格式：

```
视频内容摘要: 这里是视频的简要摘要
详细内容描述: 这里是视频的详细描述
关键词标签: 关键词1,关键词2,关键词3
主要对象: 对象1,对象2,对象3
```

### 2. 字段提取规则

系统使用正则表达式从分析结果中提取结构化数据：

- 支持中文冒号（：）和英文冒号（:）
- 自动清理多余的空格和标点符号
- 如果无法提取到摘要，会使用分析结果的前200个字符

### 3. 时间格式

- **分析时间**：视频分析完成的时间
- **同步时间**：数据同步到电子表格的时间
- 格式：`YYYY-MM-DD HH:MM:SS`

## 错误处理

### 1. 常见错误及解决方案

#### 连接失败
- **错误**：无法连接到飞书API
- **解决**：检查网络连接和App ID/Secret配置

#### 权限不足
- **错误**：没有电子表格访问权限
- **解决**：确保飞书应用具有必要的权限

#### 电子表格不存在
- **错误**：找不到指定的电子表格
- **解决**：检查电子表格Token和工作表ID是否正确

#### 数据格式错误
- **错误**：无法解析分析结果
- **解决**：确保AI分析结果采用正确的格式

### 2. 日志查看

系统会记录详细的同步日志，包括：
- API请求和响应
- 数据提取过程
- 错误信息和堆栈跟踪

可以通过控制台查看详细的日志信息进行问题排查。

### 3. 重试机制

- 网络错误会自动重试3次
- 临时性错误会延迟重试
- 永久性错误会记录并跳过

## 性能优化

### 1. 批量同步建议

- 建议每次批量同步不超过100条记录
- 大量数据建议分批处理
- 避免在网络繁忙时进行大批量同步

### 2. 同步频率控制

- 自动同步有5秒的间隔控制
- 避免频繁的手动同步操作
- 建议在非工作时间进行大批量同步

## 安全注意事项

1. **密钥保护**：妥善保管App Secret，不要在代码中硬编码
2. **权限最小化**：只授予必要的飞书权限
3. **数据备份**：定期备份电子表格数据
4. **访问控制**：合理设置电子表格的访问权限

## 故障排除

### 1. 测试连接

在设置界面使用 **测试连接** 功能验证配置：
- 检查App ID和Secret是否正确
- 验证电子表格Token和工作表ID
- 确认网络连接正常

### 2. 查看同步状态

在历史记录界面查看记录的同步状态：
- **已同步**：记录已成功同步到电子表格
- **未同步**：记录尚未同步
- **同步失败**：记录同步过程中出现错误

### 3. 手动验证

可以直接访问飞书电子表格验证数据是否正确同步：
1. 打开目标电子表格
2. 检查数据是否按预期格式显示
3. 验证时间戳和状态信息

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持基本的电子表格同步功能
- 提供自动和手动同步选项
- 包含错误处理和状态监控

---

如有问题或建议，请联系技术支持团队。