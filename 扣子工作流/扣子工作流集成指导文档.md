# 扣子工作流集成指导文档

## 概述

本文档提供了将 `input_format_adapter.py` 代码集成到扣子工作流中的详细步骤和最佳实践。

## 快速解决方案

### 步骤1：在扣子工作流中创建代码块

1. 登录扣子平台（https://www.coze.cn）
2. 进入您的工作流编辑器
3. 添加「代码」节点
4. 选择 Python 语言

### 步骤2：配置输入参数

在代码块的输入配置中：
- 参数名：`input`
- 参数类型：`string`
- 参数值：引用上游节点的输出（如用户输入或其他节点的结果）

### 步骤3：粘贴适配代码

将以下代码粘贴到扣子工作流的代码块中：

```python
# 扣子工作流专用代码
params = args.params
input_data = params.get('input', '')

import json
import re

# 字段映射配置
field_mapping = {
    'video_serial_number': ['视频编号', 'video_serial_number', '编号', 'serial_number'],
    'video_content_summary': ['视频内容概要', 'video_content_summary', '内容概要', 'summary'],
    'detailed_content_description': ['详细内容描述', 'detailed_content_description', '详细描述', 'description'],
    'keyword_tags': ['关键词标签', 'keyword_tags', '标签', 'tags'],
    'main_objects': ['主要对象', 'main_objects', '对象', 'objects']
}

def clean_json_string(json_str):
    """清理JSON字符串中的特殊字符"""
    if not isinstance(json_str, str):
        return json_str
    
    # 移除控制字符
    cleaned = re.sub(r'[\x00-\x1f\x7f-\x9f]', '', json_str)
    # 移除可能的BOM
    cleaned = cleaned.lstrip('\ufeff')
    return cleaned.strip()

def parse_input_data(data):
    """解析输入数据"""
    if isinstance(data, dict):
        return data
    
    if isinstance(data, str):
        # 尝试解析JSON
        try:
            cleaned = clean_json_string(data)
            return json.loads(cleaned)
        except:
            # 如果不是JSON，尝试解析键值对
            return parse_key_value_pairs(data)
    
    if isinstance(data, list) and len(data) > 0:
        return data[0] if isinstance(data[0], dict) else {}
    
    return {}

def parse_key_value_pairs(text):
    """解析键值对格式的文本"""
    result = {}
    lines = text.split('\n')
    
    for line in lines:
        line = line.strip()
        if ':' in line:
            key, value = line.split(':', 1)
            result[key.strip()] = value.strip()
        elif '=' in line:
            key, value = line.split('=', 1)
            result[key.strip()] = value.strip()
    
    return result

def extract_fields(data):
    """提取并映射字段"""
    parsed_data = parse_input_data(data)
    result = {}
    
    # 字段映射
    for target_field, possible_keys in field_mapping.items():
        field_value = ''
        
        # 尝试匹配可能的键名
        for key in possible_keys:
            if key in parsed_data:
                field_value = str(parsed_data[key])
                break
            
            # 尝试模糊匹配（忽略大小写）
            for data_key in parsed_data.keys():
                if key.lower() in str(data_key).lower():
                    field_value = str(parsed_data[data_key])
                    break
            
            if field_value:
                break
        
        result[target_field] = field_value
    
    return result

# 主处理逻辑
try:
    # 处理输入数据
    extracted_fields = extract_fields(input_data)
    
    # 构建返回结果
    ret = {
        'video_serial_number': extracted_fields.get('video_serial_number', ''),
        'video_content_summary': extracted_fields.get('video_content_summary', ''),
        'detailed_content_description': extracted_fields.get('detailed_content_description', ''),
        'keyword_tags': extracted_fields.get('keyword_tags', ''),
        'main_objects': extracted_fields.get('main_objects', ''),
        'status': 'success',
        'message': '数据处理成功'
    }
    
    # 检查是否有有效数据
    has_data = any(value.strip() for value in [
        ret['video_serial_number'],
        ret['video_content_summary'],
        ret['detailed_content_description'],
        ret['keyword_tags'],
        ret['main_objects']
    ])
    
    if not has_data:
        ret['status'] = 'warning'
        ret['message'] = '未能提取到有效字段，请检查输入数据格式'
        # 添加调试信息
        ret['debug_input_type'] = str(type(input_data))
        ret['debug_input_preview'] = str(input_data)[:200] if input_data else 'Empty input'
        
except Exception as e:
    # 错误处理
    ret = {
        'video_serial_number': '',
        'video_content_summary': '',
        'detailed_content_description': '',
        'keyword_tags': '',
        'main_objects': '',
        'status': 'error',
        'message': f'处理出错: {str(e)}',
        'debug_error': str(e),
        'debug_input': str(input_data)[:200] if input_data else 'No input'
    }
```

### 步骤4：配置输出字段

在代码块的输出配置中，添加以下字段：

| 字段名 | 类型 | 描述 |
|--------|------|------|
| `video_serial_number` | string | 视频编号 |
| `video_content_summary` | string | 视频内容概要 |
| `detailed_content_description` | string | 详细内容描述 |
| `keyword_tags` | string | 关键词标签 |
| `main_objects` | string | 主要对象 |
| `status` | string | 处理状态 |
| `message` | string | 处理消息 |

### 步骤5：连接工作流节点

1. 将代码块连接到上游数据源节点
2. 将代码块的输出连接到下游处理节点
3. 在下游节点中引用字段：`{{代码块节点名.字段名}}`

## 测试和调试

### 测试数据格式

使用以下测试数据验证工作流：

```json
{
  "视频编号": "V001",
  "视频内容概要": "这是一个关于AI技术的教学视频",
  "详细内容描述": "视频详细介绍了人工智能的基本概念和应用场景",
  "关键词标签": "AI,人工智能,技术,教学",
  "主要对象": "讲师,学生,电脑,投影仪"
}
```

### 调试步骤

1. **检查输入数据**：在代码块中添加调试输出，查看实际接收到的数据
2. **验证字段映射**：确认字段名称匹配
3. **测试输出格式**：确保所有输出字段都是字符串类型
4. **错误处理**：测试异常情况下的处理

### 常见问题解决

#### 问题1：输出字段为空

**原因**：字段名称不匹配或数据格式不正确

**解决方案**：
1. 检查输入数据的实际字段名
2. 在 `field_mapping` 中添加更多可能的字段名
3. 启用调试模式查看原始输入

#### 问题2：JSON解析失败

**原因**：输入数据包含特殊字符或格式不正确

**解决方案**：
1. 使用 `clean_json_string` 函数清理数据
2. 添加更多的数据格式支持
3. 使用键值对解析作为备选方案

#### 问题3：类型错误

**原因**：输出字段类型与定义不匹配

**解决方案**：
1. 确保所有输出都转换为字符串类型
2. 使用 `str()` 函数包装所有输出值

## 高级配置

### 自定义字段映射

如果您的数据使用不同的字段名，可以修改 `field_mapping` 配置：

```python
field_mapping = {
    'video_serial_number': ['您的字段名1', 'video_serial_number'],
    'video_content_summary': ['您的字段名2', 'video_content_summary'],
    # ... 其他字段
}
```

### 添加数据验证

```python
def validate_data(data):
    """验证数据完整性"""
    required_fields = ['video_serial_number', 'video_content_summary']
    missing_fields = []
    
    for field in required_fields:
        if not data.get(field, '').strip():
            missing_fields.append(field)
    
    return missing_fields
```

### 性能优化

1. **缓存解析结果**：对于重复数据，可以添加缓存机制
2. **批量处理**：如果需要处理多条数据，可以修改代码支持批量处理
3. **异步处理**：对于大量数据，考虑使用异步处理

## 最佳实践

1. **错误处理**：始终包含完整的错误处理逻辑
2. **日志记录**：在关键步骤添加日志输出
3. **数据验证**：验证输入数据的格式和完整性
4. **类型转换**：确保所有输出都是正确的类型
5. **文档更新**：及时更新字段映射和配置文档

## 支持和维护

如果遇到问题：

1. 检查扣子工作流的运行日志
2. 验证输入数据格式
3. 测试字段映射配置
4. 查看错误消息和调试信息
5. 参考扣子官方文档：https://www.coze.cn/docs

通过以上步骤，您应该能够成功将代码集成到扣子工作流中并获得预期的输出结果。